<svg id="mermaid-output" width="100%" xmlns="http://www.w3.org/2000/svg" class="flowchart" style="max-width: 1282.9921875px;" viewBox="0 0 1282.9921875 1075.53125" role="graphics-document document" aria-roledescription="flowchart-v2"><style>#mermaid-output{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-output .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-output .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-output .error-icon{fill:#552222;}#mermaid-output .error-text{fill:#552222;stroke:#552222;}#mermaid-output .edge-thickness-normal{stroke-width:1px;}#mermaid-output .edge-thickness-thick{stroke-width:3.5px;}#mermaid-output .edge-pattern-solid{stroke-dasharray:0;}#mermaid-output .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-output .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-output .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-output .marker{fill:#333333;stroke:#333333;}#mermaid-output .marker.cross{stroke:#333333;}#mermaid-output svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-output p{margin:0;}#mermaid-output .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-output .cluster-label text{fill:#333;}#mermaid-output .cluster-label span{color:#333;}#mermaid-output .cluster-label span p{background-color:transparent;}#mermaid-output .label text,#mermaid-output span{fill:#333;color:#333;}#mermaid-output .node rect,#mermaid-output .node circle,#mermaid-output .node ellipse,#mermaid-output .node polygon,#mermaid-output .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-output .rough-node .label text,#mermaid-output .node .label text,#mermaid-output .image-shape .label,#mermaid-output .icon-shape .label{text-anchor:middle;}#mermaid-output .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-output .rough-node .label,#mermaid-output .node .label,#mermaid-output .image-shape .label,#mermaid-output .icon-shape .label{text-align:center;}#mermaid-output .node.clickable{cursor:pointer;}#mermaid-output .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#mermaid-output .arrowheadPath{fill:#333333;}#mermaid-output .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-output .flowchart-link{stroke:#333333;fill:none;}#mermaid-output .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#mermaid-output .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#mermaid-output .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#mermaid-output .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#mermaid-output .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-output .cluster text{fill:#333;}#mermaid-output .cluster span{color:#333;}#mermaid-output div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-output .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-output rect.text{fill:none;stroke-width:0;}#mermaid-output .icon-shape,#mermaid-output .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#mermaid-output .icon-shape p,#mermaid-output .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#mermaid-output .icon-shape rect,#mermaid-output .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#mermaid-output .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#mermaid-output .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#mermaid-output :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker id="mermaid-output_flowchart-v2-pointEnd" class="marker flowchart-v2" viewBox="0 0 10 10" refX="5" refY="5" markerUnits="userSpaceOnUse" markerWidth="8" markerHeight="8" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowMarkerPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker><marker id="mermaid-output_flowchart-v2-pointStart" class="marker flowchart-v2" viewBox="0 0 10 10" refX="4.5" refY="5" markerUnits="userSpaceOnUse" markerWidth="8" markerHeight="8" orient="auto"><path d="M 0 5 L 10 10 L 10 0 z" class="arrowMarkerPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker><marker id="mermaid-output_flowchart-v2-circleEnd" class="marker flowchart-v2" viewBox="0 0 10 10" refX="11" refY="5" markerUnits="userSpaceOnUse" markerWidth="11" markerHeight="11" orient="auto"><circle cx="5" cy="5" r="5" class="arrowMarkerPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></circle></marker><marker id="mermaid-output_flowchart-v2-circleStart" class="marker flowchart-v2" viewBox="0 0 10 10" refX="-1" refY="5" markerUnits="userSpaceOnUse" markerWidth="11" markerHeight="11" orient="auto"><circle cx="5" cy="5" r="5" class="arrowMarkerPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></circle></marker><marker id="mermaid-output_flowchart-v2-crossEnd" class="marker cross flowchart-v2" viewBox="0 0 11 11" refX="12" refY="5.2" markerUnits="userSpaceOnUse" markerWidth="11" markerHeight="11" orient="auto"><path d="M 1,1 l 9,9 M 10,1 l -9,9" class="arrowMarkerPath" style="stroke-width: 2; stroke-dasharray: 1, 0;"></path></marker><marker id="mermaid-output_flowchart-v2-crossStart" class="marker cross flowchart-v2" viewBox="0 0 11 11" refX="-1" refY="5.2" markerUnits="userSpaceOnUse" markerWidth="11" markerHeight="11" orient="auto"><path d="M 1,1 l 9,9 M 10,1 l -9,9" class="arrowMarkerPath" style="stroke-width: 2; stroke-dasharray: 1, 0;"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g class="root" transform="translate(0, 83.9453125)"><g class="clusters"><g class="cluster" id="MEDIUM" data-look="classic"><rect style="fill:#eff6ff !important;stroke:#3b82f6 !important" x="8" y="8" width="335" height="891.640625"></rect><g class="cluster-label" transform="translate(94.083984375, 8)"><foreignObject width="162.83203125" height="23.984375"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel" style="color:#000 !important"><p>MEDIUM - Nice to Have</p></span></div></foreignObject></g></g></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g class="node default" id="flowchart-M1-8" transform="translate(175.5, 129.953125)"><rect class="basic label-container" style="" x="-130" y="-86.953125" width="260" height="173.90625"></rect><g class="label" style="" transform="translate(-100, -71.953125)"><rect></rect><foreignObject width="200" height="143.90625"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel"><p>M1: Prompts inline in agent files<br>Plan: _shared/prompts/ directory<br>FIX: Extract prompts to shared files</p></span></div></foreignObject></g></g><g class="node default" id="flowchart-M2-9" transform="translate(175.5, 353.859375)"><rect class="basic label-container" style="" x="-130" y="-86.953125" width="260" height="173.90625"></rect><g class="label" style="" transform="translate(-100, -71.953125)"><rect></rect><foreignObject width="200" height="143.90625"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel"><p>M2: No agent_dag JSONB on sessions<br>Plan: Track DAG execution state<br>FIX: Add column in v2 migration</p></span></div></foreignObject></g></g><g class="node default" id="flowchart-M3-10" transform="translate(175.5, 577.765625)"><rect class="basic label-container" style="" x="-130" y="-86.953125" width="260" height="173.90625"></rect><g class="label" style="" transform="translate(-100, -71.953125)"><rect></rect><foreignObject width="200" height="143.90625"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel"><p>M3: No idempotency key on session create<br>Risk: Duplicate sessions on retry<br>FIX: Add idempotency_key column</p></span></div></foreignObject></g></g><g class="node default" id="flowchart-M4-11" transform="translate(175.5, 789.6796875)"><rect class="basic label-container" style="" x="-130" y="-74.9609375" width="260" height="149.921875"></rect><g class="label" style="" transform="translate(-100, -59.9609375)"><rect></rect><foreignObject width="200" height="119.921875"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel"><p>M4: Zombie cleanup only on poll<br>Risk: Stale running sessions<br>FIX: Periodic cleanup or cron</p></span></div></foreignObject></g></g></g></g><g class="root" transform="translate(385, 71.953125)"><g class="clusters"><g class="cluster" id="HIGH" data-look="classic"><rect style="fill:#fffbeb !important;stroke:#f59e0b !important" x="8" y="8" width="335" height="915.625"></rect><g class="cluster-label" transform="translate(113.048828125, 8)"><foreignObject width="124.90234375" height="23.984375"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel" style="color:#000 !important"><p>HIGH - Should Fix</p></span></div></foreignObject></g></g></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g class="node default" id="flowchart-H1-4" transform="translate(175.5, 105.96875)"><rect class="basic label-container" style="" x="-130" y="-62.96875" width="260" height="125.9375"></rect><g class="label" style="" transform="translate(-100, -47.96875)"><rect></rect><foreignObject width="200" height="95.9375"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel"><p>H1: Verifier comment says 14, array has 15<br>Location: verifier.ts line 19<br>FIX: Change comment to 15</p></span></div></foreignObject></g></g><g class="node default" id="flowchart-H2-5" transform="translate(175.5, 329.875)"><rect class="basic label-container" style="" x="-130" y="-110.9375" width="260" height="221.875"></rect><g class="label" style="" transform="translate(-100, -95.9375)"><rect></rect><foreignObject width="200" height="191.875"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel"><p>H2: Composer maxOutputTokens: 4096<br>Gemini 3 known ~4k truncation issue<br>FIX: Increase to 8192 with repair fallback<br>OR bump to gemini-3-pro for Composer</p></span></div></foreignObject></g></g><g class="node default" id="flowchart-H3-6" transform="translate(175.5, 577.765625)"><rect class="basic label-container" style="" x="-130" y="-86.953125" width="260" height="173.90625"></rect><g class="label" style="" transform="translate(-100, -71.953125)"><rect></rect><foreignObject width="200" height="143.90625"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel"><p>H3: Pipeline deadline 115s vs 400s available<br>Paid plan: 400s wall-clock now<br>FIX: Increase to 300s for v1, remove for v2</p></span></div></foreignObject></g></g><g class="node default" id="flowchart-H4-7" transform="translate(175.5, 801.671875)"><rect class="basic label-container" style="" x="-130" y="-86.953125" width="260" height="173.90625"></rect><g class="label" style="" transform="translate(-100, -71.953125)"><rect></rect><foreignObject width="200" height="143.90625"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel"><p>H4: No composite index on validator_runs<br>Queries by (session_id, agent_name)<br>FIX: CREATE INDEX on (session_id, agent_name)</p></span></div></foreignObject></g></g></g></g><g class="root" transform="translate(770, 0)"><g class="clusters"><g class="cluster" id="CRITICAL" data-look="classic"><rect style="fill:#fef2f2 !important;stroke:#ef4444 !important" x="8" y="8" width="496.9921875" height="1059.53125"></rect><g class="cluster-label" transform="translate(156.49609375, 8)"><foreignObject width="200" height="47.96875"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel" style="color:#000 !important"><p>CRITICAL - Must Fix Before v2</p></span></div></foreignObject></g></g></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g class="node default" id="flowchart-C1-0" transform="translate(256.49609375, 117.9609375)"><rect class="basic label-container" style="" x="-210.99609375" y="-74.9609375" width="421.9921875" height="149.921875"></rect><g class="label" style="" transform="translate(-180.99609375, -59.9609375)"><rect></rect><foreignObject width="361.9921875" height="119.921875"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel"><p>C1: Session status enum mismatch<br>DB: running|complete|partial|failed<br>Plan: queued|running|success|degraded_success|failed<br>FIX: Migration to add new statuses</p></span></div></foreignObject></g></g><g class="node default" id="flowchart-C2-1" transform="translate(256.49609375, 365.8515625)"><rect class="basic label-container" style="" x="-130" y="-122.9296875" width="260" height="245.859375"></rect><g class="label" style="" transform="translate(-100, -107.9296875)"><rect></rect><foreignObject width="200" height="215.859375"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel"><p>C2: No validator_agent_runs table<br>Current: validator_runs (no attempt column)<br>Plan: validator_agent_runs with (session_id, agent_name, attempt)<br>FIX: Create new table + unique constraint</p></span></div></foreignObject></g></g><g class="node default" id="flowchart-C3-2" transform="translate(256.49609375, 649.71875)"><rect class="basic label-container" style="" x="-130" y="-110.9375" width="260" height="221.875"></rect><g class="label" style="" transform="translate(-100, -95.9375)"><rect></rect><foreignObject width="200" height="191.875"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel"><p>C3: No per-agent retry endpoint<br>Current: Full pipeline restart only<br>Plan: POST /validator-orchestrate {retry: 'MVP'}<br>FIX: Build retry API + frontend buttons</p></span></div></foreignObject></g></g><g class="node default" id="flowchart-C4-3" transform="translate(256.49609375, 921.59375)"><rect class="basic label-container" style="" x="-146.89453125" y="-110.9375" width="293.7890625" height="221.875"></rect><g class="label" style="" transform="translate(-116.89453125, -95.9375)"><rect></rect><foreignObject width="233.7890625" height="191.875"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel"><p>C4: Fire-and-forget without waitUntil<br>Current: runPipeline().catch().finally()<br>Docs: EdgeRuntime.waitUntil(promise)<br>FIX: Wrap background pipeline in waitUntil</p></span></div></foreignObject></g></g></g></g></g></g></g></svg>