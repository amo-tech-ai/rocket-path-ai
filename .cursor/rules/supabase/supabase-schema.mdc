---
description: Schema management for Supabase — manual migrations workflow
alwaysApply: false
globs: ["supabase/**", "**/migrations/**"]
---

# Supabase Schema Management

## Project Workflow: Manual Migrations

This project uses **manual migrations** (66 migration files in `supabase/migrations/`). Schema changes are written as SQL migration files and applied with `supabase db push`.

**Do NOT create a `supabase/schemas/` directory** — declarative schema management is not used in this project.

### Creating Migrations

```bash
# Create a new migration file
supabase migration new <descriptive_name>

# This creates: supabase/migrations/YYYYMMDDHHmmss_descriptive_name.sql

# Push to remote (no Docker required)
supabase db push
```

### Migration Rules

1. **Never edit applied migrations** — create new ones instead
2. **Always enable RLS** on new tables: `alter table X enable row level security;`
3. **Use `if not exists`** for idempotency: `create index if not exists ...`
4. **Use transactions** for atomicity: `begin; ... commit;`
5. **Granular RLS policies** — one per operation per role (no `FOR ALL`)

### Migration File Naming

- Format: `YYYYMMDDHHmmss_short_description.sql`
- UTC timestamp
- Lowercase with underscores
- Examples:
  - `20260210120000_add_profiles_table.sql`
  - `20260210120001_fix_org_creation_trigger.sql`

## Alternative: Declarative Schema (Not Used)

Supabase also supports declarative schema via `supabase/schemas/*.sql` + `supabase db diff`. This requires Docker and is not the workflow used in this project. See [official docs](https://supabase.com/docs/guides/local-development/declarative-database-schemas) if needed.

### Known Caveats of `db diff`

If switching to declarative schema, these entities must still be manual migrations:

- **DML statements** — insert, update, delete not captured
- **View ownership** — grants, security invoker, materialized views
- **RLS policies** — `alter policy` statements, column privileges
- **Other** — schema privileges, comments, partitions, publications, domains

---

**Non-compliance with migration conventions may lead to inconsistent database states.**
