---
description: Guide for creating and using Claude Agent SDK applications - build applications that interact with Claude Code using TypeScript or Python, including MCP integration, subagents, permissions, and custom tools
globs: ["**/*agent*.ts", "**/*agent*.py", "**/.mcp.json", "**/.claude/agents/**"]
alwaysApply: false
---

# Claude Agent SDK — Cursor Rule

**Purpose:** Build applications that interact with Claude Code using the Claude Agent SDK  
**Based on:** [Claude Agent SDK Documentation](https://docs.claude.com/en/api/agent-sdk/overview)  
**Skill Reference:** `.cursor/skills/claude-sdk/SKILL.md`  
**Best for:** Creating AI agents, integrating MCP servers, building custom tools, implementing subagents

---

## What Is Claude Agent SDK?

Claude Agent SDK allows you to build applications that interact with Claude Code, providing access to:
- **Code reading and writing tools** (Read, Write, Grep, Glob)
- **File system operations** (via MCP servers)
- **Custom MCP tools** (create your own tools)
- **Subagents** (specialized AI assistants for specific tasks)
- **Streaming and single-mode responses**
- **Permissions and security controls**

**Supported Languages:**
- **TypeScript** (recommended for Node.js projects)
- **Python** (recommended for Python ecosystems)

**Official Documentation:**
- Overview: https://docs.claude.com/en/api/agent-sdk/overview
- TypeScript: https://docs.claude.com/en/api/agent-sdk/typescript
- Python: https://docs.claude.com/en/api/agent-sdk/python

---

## When to Use Claude Agent SDK

### ✅ Use Claude SDK When

| Scenario | Why Use Claude SDK |
|----------|-------------------|
| **Building AI agents** | Create applications that use Claude Code capabilities |
| **Integrating MCP servers** | Connect to external tools and services via MCP |
| **Creating custom tools** | Build SDK MCP servers for specialized functionality |
| **Implementing subagents** | Delegate tasks to specialized AI assistants |
| **Automating workflows** | Build agents that perform complex, multi-step tasks |
| **Code analysis tools** | Create tools that analyze, review, or modify code |

### ❌ Use Other Approaches When

| Scenario | Why Use Other Approaches |
|----------|-------------------------|
| **Simple API calls** | Use `@anthropic-ai/sdk` for basic Claude API interactions |
| **One-off scripts** | Direct API calls are simpler for simple tasks |
| **Frontend applications** | Use Claude API directly, SDK is for agent applications |

---

## Project Setup

### Language Selection

**Ask user first:**
- "Would you like to use TypeScript or Python?"

**Recommendations:**
- **TypeScript:** For Node.js projects, better IDE support, type safety
- **Python:** For Python ecosystems, data science workflows

### Installation

**TypeScript:**
```bash
npm install @anthropic-ai/claude-agent-sdk@latest
```

**Python:**
```bash
pip install claude-agent-sdk
```

**⚠️ Always check latest versions** before installing — use `npm view @anthropic-ai/claude-agent-sdk version` or check PyPI.

### Project Configuration

**TypeScript `package.json`:**
```json
{
  "type": "module",
  "scripts": {
    "start": "node --loader ts-node/esm index.ts",
    "typecheck": "tsc --noEmit"
  }
}
```

**TypeScript `tsconfig.json`:**
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true
  }
}
```

**Python `requirements.txt`:**
```
claude-agent-sdk>=latest
```

### Environment Configuration

**Create `.env.example`:**
```
ANTHROPIC_API_KEY=your_api_key_here
```

**Add to `.gitignore`:**
```
.env
```

**Get API Key:** https://console.anthropic.com/

---

## Basic Usage Patterns

### TypeScript Query Pattern

```typescript
import { query } from "@anthropic-ai/claude-agent-sdk";

for await (const message of query({
  prompt: "List all TypeScript files in the project",
  options: {
    allowedTools: ["Glob", "Read"]
  }
})) {
  if (message.type === "result" && message.subtype === "success") {
    console.log(message.result);
  }
}
```

### Python Query Pattern

```python
from claude_agent_sdk import query

async for message in query(
    prompt="List all Python files in the project",
    options={
        "allowedTools": ["Glob", "Read"]
    }
):
    if message["type"] == "result" and message["subtype"] == "success":
        print(message["result"])
```

### Streaming vs Single Mode

**Streaming Mode (default):**
```typescript
// Real-time responses as they arrive
for await (const message of query({
  prompt: "Analyze the codebase",
  options: { streaming: true } // Default
})) {
  if (message.type === "text_delta") {
    process.stdout.write(message.text);
  }
}
```

**Single Mode:**
```typescript
// Complete response after all messages
const result = await query({
  prompt: "List all files",
  options: { streaming: false }
}).then(async (query) => {
  let fullResult = "";
  for await (const message of query) {
    if (message.type === "result" && message.subtype === "success") {
      fullResult = message.result;
    }
  }
  return fullResult;
});
```

---

## MCP Integration

### MCP Configuration

**Configure MCP servers in `.mcp.json` at project root:**

```json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": ["@modelcontextprotocol/server-filesystem"],
      "env": {
        "ALLOWED_PATHS": "/Users/me/projects"
      }
    }
  }
}
```

### Using MCP Servers in SDK

**TypeScript:**
```typescript
import { query } from "@anthropic-ai/claude-agent-sdk";

for await (const message of query({
  prompt: "List files in my project",
  options: {
    mcpServers: {
      "filesystem": {
        command: "npx",
        args: ["@modelcontextprotocol/server-filesystem"],
        env: {
          ALLOWED_PATHS: "/Users/me/projects"
        }
      }
    },
    allowedTools: ["mcp__filesystem__list_files"]
  }
})) {
  if (message.type === "result" && message.subtype === "success") {
    console.log(message.result);
  }
}
```

**Python:**
```python
from claude_agent_sdk import query

async for message in query(
    prompt="List files in my project",
    options={
        "mcpServers": {
            "filesystem": {
                "command": "python",
                "args": ["-m", "mcp_server_filesystem"],
                "env": {
                    "ALLOWED_PATHS": "/Users/me/projects"
                }
            }
        },
        "allowedTools": ["mcp__filesystem__list_files"]
    }
):
    if message["type"] == "result" and message["subtype"] == "success":
        print(message["result"])
```

### MCP Transport Types

**stdio Servers (external processes):**
```json
{
  "mcpServers": {
    "my-tool": {
      "command": "node",
      "args": ["./my-mcp-server.js"],
      "env": {
        "DEBUG": "${DEBUG:-false}"
      }
    }
  }
}
```

**HTTP/SSE Servers (remote):**
```json
{
  "mcpServers": {
    "remote-api": {
      "type": "sse",
      "url": "https://api.example.com/mcp/sse",
      "headers": {
        "Authorization": "Bearer ${API_TOKEN}"
      }
    }
  }
}
```

### Error Handling for MCP

**Check MCP server status:**
```typescript
for await (const message of query({
  prompt: "Process data",
  options: {
    mcpServers: {
      "data-processor": dataServer
    }
  }
})) {
  if (message.type === "system" && message.subtype === "init") {
    // Check MCP server status
    const failedServers = message.mcp_servers.filter(
      s => s.status !== "connected"
    );
    
    if (failedServers.length > 0) {
      console.warn("Failed to connect:", failedServers);
    }
  }
  
  if (message.type === "result" && message.subtype === "error_during_execution") {
    console.error("Execution failed:", message.error);
  }
}
```

---

## Custom Tools (SDK MCP Servers)

### Creating Custom Tools

**TypeScript:**
```typescript
import { tool, createSdkMcpServer, query } from "@anthropic-ai/claude-agent-sdk";
import { z } from "zod";

// Define tool with Zod schema
const calculateTool = tool(
  "calculate",
  "Performs mathematical calculations",
  {
    expression: z.string().describe("Mathematical expression to evaluate")
  },
  async (args) => {
    // Execute tool logic (use safe evaluator in production)
    const result = eval(args.expression);
    return {
      success: true,
      result: result.toString()
    };
  }
);

// Create MCP server with tools
const calculatorServer = createSdkMcpServer({
  name: "calculator",
  version: "1.0.0",
  tools: [calculateTool]
});

// Use in query
for await (const message of query({
  prompt: "Calculate 2 + 2",
  options: {
    mcpServers: {
      "calculator": calculatorServer
    },
    allowedTools: ["mcp__calculator__calculate"]
  }
})) {
  if (message.type === "result") {
    console.log(message.result);
  }
}
```

**Python:**
```python
from claude_agent_sdk import tool, create_sdk_mcp_server, query
from pydantic import BaseModel

# Define tool with Pydantic schema
class CalculateInput(BaseModel):
    expression: str

@tool("calculate", "Performs mathematical calculations", CalculateInput)
async def calculate_handler(args: CalculateInput):
    result = eval(args.expression)  # Use safe evaluator in production
    return {"success": True, "result": str(result)}

# Create MCP server with tools
calculator_server = create_sdk_mcp_server(
    name="calculator",
    version="1.0.0",
    tools=[calculate_handler]
)
```

---

## Subagents

### Creating Subagents

**Programmatic Definition (Recommended):**

**TypeScript:**
```typescript
import { query } from "@anthropic-ai/claude-agent-sdk";

for await (const message of query({
  prompt: "Review the authentication module for security issues",
  options: {
    allowedTools: ["Read", "Grep", "Glob", "Task"], // Task tool required
    agents: {
      "code-reviewer": {
        description: "Expert code review specialist. Use for quality, security, and maintainability reviews.",
        prompt: `You are a code review specialist with expertise in security, performance, and best practices.

When reviewing code:
- Identify security vulnerabilities
- Check for performance issues
- Verify adherence to coding standards
- Suggest specific improvements

Be thorough but concise in your feedback.`,
        tools: ["Read", "Grep", "Glob"], // Read-only access
        model: "sonnet" // Override default model
      }
    }
  }
})) {
  if (message.type === "result") {
    console.log(message.result);
  }
}
```

**Python:**
```python
from claude_agent_sdk import query, AgentDefinition

async for message in query(
    prompt="Review the authentication module for security issues",
    options={
        "allowedTools": ["Read", "Grep", "Glob", "Task"],
        "agents": {
            "code-reviewer": AgentDefinition(
                description="Expert code review specialist. Use for quality, security, and maintainability reviews.",
                prompt="""You are a code review specialist with expertise in security, performance, and best practices.

When reviewing code:
- Identify security vulnerabilities
- Check for performance issues
- Verify adherence to coding standards
- Suggest specific improvements

Be thorough but concise in your feedback.""",
                tools=["Read", "Grep", "Glob"],
                model="sonnet"
            )
        }
    }
):
    if message["type"] == "result":
        print(message["result"])
```

### Subagent Benefits

**Context Management:**
- Subagents maintain separate context from main agent
- Prevents information overload
- Keeps interactions focused

**Parallelization:**
- Multiple subagents can run concurrently
- Dramatically speeds up complex workflows
- Example: Run `style-checker`, `security-scanner`, and `test-coverage` simultaneously

**Specialized Instructions:**
- Each subagent can have tailored system prompts
- Specific expertise and best practices
- Tool restrictions for safety

**Tool Restrictions:**
- Limit subagents to specific tools
- Reduce risk of unintended actions
- Example: `doc-reviewer` with read-only access

### Common Subagent Patterns

**Code Reviewer:**
```typescript
agents: {
  "code-reviewer": {
    description: "Expert code review specialist. Use for quality, security, and maintainability reviews.",
    prompt: `Focus on:
- Security vulnerabilities
- Performance issues
- Code quality and maintainability
- Best practices adherence`,
    tools: ["Read", "Grep", "Glob"], // Read-only
    model: "sonnet"
  }
}
```

**Test Runner:**
```typescript
agents: {
  "test-runner": {
    description: "Runs test suites and reports results. Use for automated testing.",
    prompt: `Run tests and report:
- Test results (pass/fail)
- Coverage metrics
- Performance benchmarks
- Error details`,
    tools: ["Bash"], // Can execute commands
    model: "sonnet"
  }
}
```

**Research Assistant:**
```typescript
agents: {
  "research-assistant": {
    description: "Research specialist. Use for exploring codebases and documentation.",
    prompt: `Explore and analyze:
- Codebase structure
- Documentation
- API references
- Implementation patterns`,
    tools: ["Read", "Grep", "Glob", "WebFetch"], // Read and fetch
    model: "sonnet"
  }
}
```

---

## Permissions

### Permission Modes

**Default:** `"promptUser"`
- Claude prompts user before executing actions
- Safest mode for production

**Bypass:** `"bypassPermissions"`
- Allows automatic execution without prompts
- Requires `allowDangerouslySkipPermissions: true`
- ⚠️ Use with caution — only in controlled environments

**Configuration:**
```typescript
options: {
  permissionMode: "promptUser", // or "bypassPermissions"
  allowDangerouslySkipPermissions: false // Required for bypass
}
```

---

## Verification

### TypeScript Verification

**Run type checking:**
```bash
npx tsc --noEmit
```

**Verify SDK installation:**
```bash
npm list @anthropic-ai/claude-agent-sdk
```

**Check for type errors:**
- ✅ All imports resolve correctly
- ✅ Types match SDK documentation
- ✅ No compilation errors
- ✅ Configuration options are valid

### Verification Checklist

**SDK Installation:**
- ✅ Package installed with latest version
- ✅ `package.json` has `"type": "module"` for ES modules (TypeScript)
- ✅ Node.js/Python version requirements met

**TypeScript Configuration:**
- ✅ `tsconfig.json` exists with proper settings
- ✅ Module resolution supports ES modules
- ✅ Target is modern enough for SDK
- ✅ Type checking passes (`tsc --noEmit`)

**SDK Usage:**
- ✅ Correct imports from `@anthropic-ai/claude-agent-sdk`
- ✅ Agents properly initialized
- ✅ Configuration follows SDK patterns
- ✅ Methods called correctly with proper parameters
- ✅ Streaming vs single mode handled correctly

**Environment and Security:**
- ✅ `.env.example` exists with `ANTHROPIC_API_KEY`
- ✅ `.env` is in `.gitignore`
- ✅ API keys not hardcoded in source files
- ✅ Proper error handling around API calls

**MCP Integration (if used):**
- ✅ `.mcp.json` configured correctly
- ✅ MCP servers can connect
- ✅ Tools are accessible
- ✅ Error handling for connection failures

**Subagents (if used):**
- ✅ `Task` tool included in `allowedTools`
- ✅ Subagent descriptions are clear
- ✅ Tool restrictions are appropriate
- ✅ Models are specified correctly

---

## Best Practices

### ✅ DO

- **Always use latest SDK versions** — Check npm/PyPI before installing
- **Use TypeScript for type safety** — Better IDE support and error catching
- **Verify code runs correctly** — Run `tsc --noEmit` for TypeScript before finishing
- **Use `.env` for API keys** — Never hardcode API keys in source files
- **Write clear subagent descriptions** — Helps Claude decide when to use them
- **Use tool restrictions for subagents** — Reduces risk of unintended actions
- **Handle MCP connection failures** — Check server status and handle errors gracefully
- **Use streaming mode for real-time feedback** — Better UX for interactive applications
- **Test with verification agents** — Use `agent-sdk-verifier-ts` or `agent-sdk-verifier-py` after setup

### ❌ DON'T

- **Don't skip version checking** — Always use latest versions
- **Don't hardcode API keys** — Use `.env` files
- **Don't forget `.env` in `.gitignore`** — Security risk
- **Don't skip type checking** — Fix all TypeScript errors before finishing
- **Don't use `bypassPermissions` without understanding risks** — Only in controlled environments
- **Don't forget `Task` tool when using subagents** — Required for subagent invocation
- **Don't ignore MCP connection errors** — Handle failures gracefully
- **Don't create overly permissive subagents** — Restrict tools to what's needed

---

## Common Patterns

### Code Review Agent

**Use case:** Automated code review with security focus

```typescript
agents: {
  "code-reviewer": {
    description: "Expert code review specialist. Use for quality, security, and maintainability reviews.",
    prompt: `You are a code review specialist focusing on:
- Security vulnerabilities
- Performance issues
- Code quality and maintainability
- Best practices adherence`,
    tools: ["Read", "Grep", "Glob"], // Read-only
    model: "sonnet"
  }
}
```

### Test Runner Agent

**Use case:** Run tests and report results

```typescript
agents: {
  "test-runner": {
    description: "Runs test suites and reports results. Use for automated testing.",
    prompt: `Run tests and report:
- Test results (pass/fail)
- Coverage metrics
- Performance benchmarks
- Error details`,
    tools: ["Bash"], // Can execute commands
    model: "sonnet"
  }
}
```

### Research Assistant Agent

**Use case:** Explore documentation and codebase

```typescript
agents: {
  "research-assistant": {
    description: "Research specialist. Use for exploring codebases and documentation.",
    prompt: `Explore and analyze:
- Codebase structure
- Documentation
- API references
- Implementation patterns`,
    tools: ["Read", "Grep", "Glob", "WebFetch"], // Read and fetch
    model: "sonnet"
  }
}
```

---

## Troubleshooting

### Common Issues

**Issue: Type errors in TypeScript**

**Solution:**
```bash
# Run type checking
npx tsc --noEmit

# Fix all errors before finishing
# Verify imports and types match SDK documentation
```

**Issue: MCP server connection failed**

**Solution:**
```typescript
// Check MCP server status
if (message.type === "system" && message.subtype === "init") {
  const failedServers = message.mcp_servers.filter(
    s => s.status !== "connected"
  );
  
  if (failedServers.length > 0) {
    console.warn("Failed to connect:", failedServers);
    // Check .mcp.json configuration
    // Verify MCP server is installed and accessible
  }
}
```

**Issue: Subagent not invoked**

**Solution:**
- ✅ Ensure `Task` tool is in `allowedTools`
- ✅ Write clear subagent description
- ✅ Explicitly request subagent by name if needed: "Use the code-reviewer agent to..."

**Issue: Permission errors**

**Solution:**
- Use `permissionMode: "promptUser"` for production
- Only use `bypassPermissions` in controlled environments
- Ensure `allowDangerouslySkipPermissions: true` if bypassing

---

## Reference

### Official Documentation

- **Overview:** https://docs.claude.com/en/api/agent-sdk/overview
- **TypeScript:** https://docs.claude.com/en/api/agent-sdk/typescript
- **Python:** https://docs.claude.com/en/api/agent-sdk/python
- **MCP Integration:** https://docs.claude.com/en/api/agent-sdk/mcp
- **Subagents:** https://docs.claude.com/en/api/agent-sdk/subagents
- **Custom Tools:** https://docs.claude.com/en/api/agent-sdk/custom-tools

### Project Files

- **Skill:** `.cursor/skills/claude-sdk/SKILL.md` — Comprehensive skill reference
- **Reference Docs:** `claude-reference/skills/sdk-agent-new.md` — Creating new SDK applications
- **Verifier:** `claude-reference/skills/sdk-verifier.md` — Verification patterns
- **MCP Guide:** `claude-reference/agents/mcp.md` — MCP integration details

### Related Rules

- **Agent Skills:** `.cursor/rules/agent-skills.mdc` — Agent Skills pattern
- **Subagents:** `.cursor/rules/subagents.mdc` — Subagents pattern (Cursor subagents)
- **MCP Integration:** `.cursor/rules/mcp-integration.mdc` — MCP integration patterns

---

**Created:** 2025-01-16  
**Based on:** Claude Agent SDK documentation and best practices  
**Skill Reference:** `.cursor/skills/claude-sdk/SKILL.md`  
**Version:** 1.0.0
